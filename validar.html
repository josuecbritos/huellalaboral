<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validación de Documentos - Huella Laboral</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --azul: #0E2A47;
            --verde: #2FBF71;
            --texto: #1F2937;
            --subtitulo: #6B7280;
            --borde: #E5E7EB;
            --fondo: #FFFFFF;
            --fondo-gris: #F9FAFB;
            --error: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--fondo-gris);
            color: var(--texto);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 180px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--azul);
            margin-bottom: 8px;
        }

        .header p {
            font-size: 15px;
            color: var(--subtitulo);
        }

        /* Token Error State */
        .token-error {
            display: none;
            background: white;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 40px;
            text-align: center;
        }

        .token-error.visible {
            display: block;
        }

        .token-error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .token-error h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--texto);
            margin-bottom: 8px;
        }

        .token-error p {
            font-size: 14px;
            color: var(--subtitulo);
        }

        /* Main Content */
        .main-content {
            display: none;
        }

        .main-content.visible {
            display: block;
        }

        /* Info Card */
        .info-card {
            background: white;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .info-card h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--azul);
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--borde);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--subtitulo);
            width: 180px;
            flex-shrink: 0;
        }

        .info-value {
            font-size: 14px;
            color: var(--texto);
            font-weight: 500;
        }

        /* Document Links */
        .doc-links {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .doc-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--azul);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid var(--azul);
            border-radius: 4px;
            transition: background 0.15s;
        }

        .doc-link:hover {
            background: rgba(14,42,71,0.05);
        }

        .doc-link svg {
            width: 16px;
            height: 16px;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .form-section h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--azul);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--texto);
            margin-bottom: 6px;
        }

        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            padding: 10px 12px;
            border: 1px solid var(--borde);
            border-radius: 4px;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--azul);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-top: 3px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            font-size: 13px;
            font-weight: 500;
            color: var(--texto);
            cursor: pointer;
            margin: 0;
        }

        /* Conditional Fields */
        .conditional-fields {
            margin-top: 16px;
            padding: 16px;
            background: var(--fondo-gris);
            border-radius: 4px;
        }

        .conditional-fields.hidden {
            display: none;
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: var(--azul);
            border: none;
            border-radius: 4px;
            padding: 14px 24px;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Message */
        .msg {
            padding: 14px 18px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .msg.visible {
            display: block;
        }

        .msg.error {
            background: #fef2f2;
            color: var(--error);
            border: 1px solid #fecaca;
        }

        .msg.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        /* Success State */
        .success-state {
            display: none;
            background: white;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 48px 32px;
            text-align: center;
        }

        .success-state.visible {
            display: block;
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background: #dcfce7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-icon svg {
            width: 32px;
            height: 32px;
            stroke: #16a34a;
        }

        .success-state h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--azul);
            margin-bottom: 8px;
        }

        .success-state p {
            font-size: 15px;
            color: var(--subtitulo);
        }

        /* Field Error */
        .field-error {
            font-size: 12px;
            color: var(--error);
            margin-top: 4px;
            display: none;
        }

        .field-error.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo_huella_laboral.png" alt="Huella Laboral" class="logo">
            <h1>Validación de Documentos</h1>
            <p>Revisa y valida los documentos adjuntos por el trabajador</p>
        </div>

        <!-- Token Error -->
        <div class="token-error" id="tokenError">
            <div class="token-error-icon">⚠️</div>
            <h2>Link inválido o expirado</h2>
            <p>El link de validación no es válido o ha expirado. Por favor, contacta al administrador.</p>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            
            <!-- Información del Trabajador -->
            <div class="info-card">
                <h2>Información del Trabajador</h2>
                <div class="info-row">
                    <div class="info-label">Nombre completo</div>
                    <div class="info-value" id="trabajadorNombre">—</div>
                </div>
                <div class="info-row">
                    <div class="info-label">RUT</div>
                    <div class="info-value" id="trabajadorRut">—</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="trabajadorEmail">—</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Fecha de solicitud</div>
                    <div class="info-value" id="fechaSolicitud">—</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Documentos adjuntos</div>
                    <div class="info-value">
                        <div class="doc-links" id="docLinks"></div>
                    </div>
                </div>
            </div>

            <div class="msg" id="msgGlobal"></div>

            <!-- Formulario de Validación -->
            <form id="formValidacion">
                
                <!-- Validación Certificado de Cotizaciones -->
                <div class="form-section" id="seccionCertificado" style="display:none;">
                    <h3>Validación - Certificado de Cotizaciones</h3>
                    
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="certNoValido" onchange="toggleCertFields()">
                        <label for="certNoValido">Certificado no válido (ilegible, falsificado, no corresponde)</label>
                    </div>

                    <div id="certFieldsValidos">
                        <div class="form-group">
                            <label for="empleos5Anos">Cantidad de empleos en los últimos 5 años *</label>
                            <input type="number" id="empleos5Anos" min="0" max="20" placeholder="Ej: 3">
                            <span class="field-error" id="err-empleos5Anos"></span>
                        </div>

                        <div class="form-group">
                            <label for="tiempoMax">Tiempo máximo en un solo empleador (años) *</label>
                            <input type="number" id="tiempoMax" step="0.5" min="0" max="10" placeholder="Ej: 2.5">
                            <span class="field-error" id="err-tiempoMax"></span>
                        </div>
                    </div>

                    <div id="certFieldsInvalidos" class="conditional-fields hidden">
                        <div class="form-group">
                            <label for="razonInvalido">Razón por la cual no es válido *</label>
                            <textarea id="razonInvalido" placeholder="Ej: Documento ilegible, no corresponde al periodo solicitado..."></textarea>
                            <span class="field-error" id="err-razonInvalido"></span>
                        </div>
                    </div>
                </div>

                <!-- Validación Finiquito -->
                <div class="form-section" id="seccionFiniquito" style="display:none;">
                    <h3>Validación - Finiquito</h3>

                    <div class="form-group">
                        <label>Causal informada por el trabajador</label>
                        <div style="padding:10px 12px; background:var(--fondo-gris); border-radius:4px; font-size:14px; color:var(--texto); font-weight:500;" id="causalInformada">—</div>
                    </div>

                    <div class="form-group">
                        <label for="finiquitoValido">El finiquito es válido y coincide con la causal informada *</label>
                        <select id="finiquitoValido">
                            <option value="">Selecciona una opción</option>
                            <option value="si">Sí - Finiquito válido y causal coincide</option>
                            <option value="no">No - Finiquito inválido o causal no coincide</option>
                        </select>
                        <span class="field-error" id="err-finiquitoValido"></span>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="btnSubmit">Validar y Aprobar</button>
            </form>
        </div>

        <!-- Success State -->
        <div class="success-state" id="successState">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <path d="M22 4L12 14.01l-3-3"></path>
                </svg>
            </div>
            <h2>Validación completada exitosamente</h2>
            <p>Los documentos han sido validados y el trabajador será notificado.</p>
        </div>
    </div>

    <script>
        let tokenData = null;
        let tieneCertificado = false;
        let tieneFiniquito = false;

        // Cargar datos desde Supabase usando token
        async function cargarDatos() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            
            if (!token) {
                document.getElementById('tokenError').classList.add('visible');
                return;
            }

            try {
                const response = await fetch(`https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/obtener-validacion?token=${token}`, {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                    }
                });
                
                if (!response.ok) throw new Error();
                
                const data = await response.json();
                if (!data || data.error) {
                    document.getElementById('tokenError').classList.add('visible');
                    return;
                }

                tokenData = data;
                
                // Llenar información del trabajador
                document.getElementById('trabajadorNombre').textContent = data.trabajador_nombre || '—';
                document.getElementById('trabajadorRut').textContent = data.trabajador_rut || '—';
                document.getElementById('trabajadorEmail').textContent = data.trabajador_email || '—';
                document.getElementById('fechaSolicitud').textContent = data.fecha_solicitud ? new Date(data.fecha_solicitud).toLocaleDateString('es-CL') : '—';

                // Links de documentos
                const docLinksContainer = document.getElementById('docLinks');
                let linksHTML = '';

                if (data.certificado_url) {
                    tieneCertificado = true;
                    linksHTML += `<a href="${data.certificado_url}" target="_blank" class="doc-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path></svg>
                        Ver Certificado
                    </a>`;
                    document.getElementById('seccionCertificado').style.display = 'block';
                }

                if (data.finiquito_url) {
                    tieneFiniquito = true;
                    linksHTML += `<a href="${data.finiquito_url}" target="_blank" class="doc-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path></svg>
                        Ver Finiquito
                    </a>`;
                    document.getElementById('seccionFiniquito').style.display = 'block';
                    document.getElementById('causalInformada').textContent = data.causal_salida || '—';
                }

                docLinksContainer.innerHTML = linksHTML || 'Sin documentos adjuntos';

                document.getElementById('mainContent').classList.add('visible');

            } catch (err) {
                console.error(err);
                document.getElementById('tokenError').classList.add('visible');
            }
        }

        // Toggle campos de certificado
        function toggleCertFields() {
            const noValido = document.getElementById('certNoValido').checked;
            document.getElementById('certFieldsValidos').style.display = noValido ? 'none' : 'block';
            document.getElementById('certFieldsInvalidos').classList.toggle('hidden', !noValido);
            
            // Limpiar errores
            ['empleos5Anos', 'tiempoMax', 'razonInvalido'].forEach(id => {
                document.getElementById(`err-${id}`).classList.remove('visible');
            });
        }

        // Validación
        function validarCampo(id, errorId, condicion, mensaje) {
            const input = document.getElementById(id);
            const error = document.getElementById(errorId);
            if (!condicion(input.value)) {
                error.textContent = mensaje;
                error.classList.add('visible');
                return false;
            }
            error.classList.remove('visible');
            return true;
        }

        function validarFormulario() {
            let valido = true;

            // Validar certificado si existe
            if (tieneCertificado) {
                const certNoValido = document.getElementById('certNoValido').checked;
                
                if (!certNoValido) {
                    valido &= validarCampo('empleos5Anos', 'err-empleos5Anos',
                        v => v && parseInt(v) >= 0,
                        'Ingresa la cantidad de empleos.');
                    valido &= validarCampo('tiempoMax', 'err-tiempoMax',
                        v => v && parseFloat(v) >= 0,
                        'Ingresa el tiempo máximo.');
                } else {
                    valido &= validarCampo('razonInvalido', 'err-razonInvalido',
                        v => v.trim().length >= 10,
                        'Ingresa la razón por la cual no es válido (mínimo 10 caracteres).');
                }
            }

            // Validar finiquito si existe
            if (tieneFiniquito) {
                valido &= validarCampo('finiquitoValido', 'err-finiquitoValido',
                    v => v.length > 0,
                    'Selecciona si el finiquito es válido y coincide.');
            }

            return !!valido;
        }

        function mostrarMsg(tipo, texto) {
            const msg = document.getElementById('msgGlobal');
            msg.textContent = texto;
            msg.className = `msg ${tipo} visible`;
            msg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Submit
        document.getElementById('formValidacion').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validarFormulario()) {
                mostrarMsg('error', 'Por favor completa todos los campos requeridos.');
                return;
            }

            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            const datos = {
                token: new URLSearchParams(window.location.search).get('token'),
                certificado: tieneCertificado ? {
                    valido: !document.getElementById('certNoValido').checked,
                    empleos_ultimos_5_anos: document.getElementById('empleos5Anos').value || null,
                    tiempo_maximo_un_empleador_anos: document.getElementById('tiempoMax').value || null,
                    razon_invalido: document.getElementById('razonInvalido').value || null
                } : null,
                finiquito: tieneFiniquito ? {
                    valido_y_coincide: document.getElementById('finiquitoValido').value === 'si'
                } : null
            };

            try {
                const response = await fetch('https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/validar-documentos', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                    },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();

                if (!response.ok || result.error) {
                    throw new Error(result.error || 'Error al validar');
                }

                // Mostrar success state
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('successState').classList.add('visible');
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                console.error('Error:', err);
                mostrarMsg('error', 'Ha ocurrido un error al enviar la validación. Intenta nuevamente.');
                btn.disabled = false;
                btn.textContent = 'Validar y Aprobar';
            }
        });

        // Cargar datos al iniciar
        cargarDatos();
    </script>
</body>
</html>
