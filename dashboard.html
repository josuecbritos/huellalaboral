<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Reclutadores — Huella Laboral</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --azul: #0E2A47;
            --azul-hover: #0a1f35;
            --azul-light: rgba(14,42,71,0.06);
            --verde: #2FBF71;
            --texto: #2E2E2E;
            --subtitulo: #6B7280;
            --fondo: #FFFFFF;
            --fondo-gris: #F7F8FA;
            --borde: #E5E7EB;
            --error: #EF4444;
            --sidebar-width: 240px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--fondo-gris);
            color: var(--texto);
            font-size: 15px;
            line-height: 1.5;
            min-height: 100vh;
        }

        .app { display: flex; min-height: 100vh; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--azul);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0; left: 0;
            height: 100vh;
            z-index: 50;
        }

        .sidebar-logo {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .sidebar-logo-text { font-size: 16px; font-weight: 700; color: white; letter-spacing: -0.3px; }

        .sidebar-nav {
            flex: 1;
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-section-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.4);
            padding: 12px 8px 6px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: 'Inter', sans-serif;
        }

        .sidebar-item:hover { background: rgba(255,255,255,0.08); }
        .sidebar-item.active { background: rgba(255,255,255,0.15); }
        .sidebar-item-text { font-size: 14px; font-weight: 500; color: rgba(255,255,255,0.8); }
        .sidebar-item.active .sidebar-item-text { color: white; }
        .sidebar-item svg { flex-shrink: 0; opacity: 0.7; }
        .sidebar-item.active svg { opacity: 1; }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-user { padding: 10px; }
        .sidebar-user-name { font-size: 13px; font-weight: 500; color: white; }
        .sidebar-user-email { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 1px; }

        .btn-logout {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px 10px 0;
            text-align: left;
            transition: color 0.15s;
        }

        .btn-logout:hover { color: white; }

        /* MAIN */
        .main {
            margin-left: var(--sidebar-width);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* TOPBAR */
        .topbar {
            background: var(--fondo);
            border-bottom: 1px solid var(--borde);
            padding: 0 32px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .topbar-title { font-size: 16px; font-weight: 700; color: var(--azul); }
        .topbar-actions { display: flex; align-items: center; gap: 12px; }

        .btn-primary {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: white;
            background: var(--azul);
            border: 2px solid var(--azul);
            border-radius: 4px;
            padding: 7px 16px;
            cursor: pointer;
            transition: background 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary:hover { background: var(--azul-hover); border-color: var(--azul-hover); }

        .btn-outline {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--azul);
            background: transparent;
            border: 2px solid var(--azul);
            border-radius: 4px;
            padding: 7px 16px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .btn-outline:hover { background: var(--azul); color: white; }

        /* CONTENT */
        .content { padding: 32px; flex: 1; }

        .vista { display: none; }
        .vista.active { display: block; }

        /* STATS */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 20px 24px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--subtitulo);
            margin-bottom: 8px;
        }

        .stat-value { font-size: 28px; font-weight: 700; color: var(--azul); line-height: 1; }

        /* TABLA */
        .table-card {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }

        thead { background: var(--fondo-gris); border-bottom: 1px solid var(--borde); }

        th {
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--subtitulo);
            padding: 12px 20px;
        }

        td {
            padding: 14px 20px;
            font-size: 14px;
            color: var(--texto);
            border-bottom: 1px solid var(--borde);
        }

        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background 0.1s; }
        tbody tr:hover { background: var(--fondo-gris); }

        .td-name { font-weight: 500; color: var(--azul); }
        .td-sub { font-size: 12px; color: var(--subtitulo); margin-top: 1px; }

        /* BADGES */
        .badge {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 9px;
            border-radius: 2px;
        }

        .badge-activo, .badge-completado, .badge-completo { background: rgba(47,191,113,0.12); color: #166534; }
        .badge-en-proceso, .badge-en-progreso { background: rgba(234,179,8,0.12); color: #854d0e; }
        .badge-invitado, .badge-pendiente { background: rgba(107,114,128,0.12); color: var(--subtitulo); }

        .btn-accion {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--azul);
            background: transparent;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 5px 12px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .btn-accion:hover { border-color: var(--azul); background: var(--azul-light); }

        .btn-eliminar {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #dc2626;
            background: transparent;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .btn-eliminar:hover { 
            border-color: #dc2626; 
            background: rgba(220, 38, 38, 0.05); 
        }

        .btn-finalizar {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: var(--azul);
            background: transparent;
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .btn-finalizar:hover { 
            border-color: var(--azul); 
            background: var(--azul-light); 
        }

        /* BACK */
        .btn-back {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--subtitulo);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 24px;
            padding: 0;
            transition: color 0.15s;
        }

        .btn-back:hover { color: var(--azul); }

        /* PROCESO HEADER */
        .proceso-header {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 24px 28px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .proceso-nombre { font-size: 20px; font-weight: 700; color: var(--azul); margin-bottom: 4px; }
        .proceso-meta { font-size: 13px; color: var(--subtitulo); }

        /* TOGGLE DATA */
        .toggle-data {
            display: inline-flex;
            background: var(--fondo-gris);
            border: 1px solid var(--borde);
            border-radius: 4px;
            overflow: hidden;
        }

        .toggle-data button {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: var(--subtitulo);
            background: transparent;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .toggle-data button.active {
            background: var(--azul);
            color: white;
        }

        .toggle-data button.active.verificada {
            background: var(--verde);
        }

        .toggle-data button:hover:not(.active) {
            background: rgba(14,42,71,0.05);
        }

        /* CANDIDATO HEADER */
        .candidato-header {
            background: var(--azul);
            border-radius: 4px;
            padding: 24px 28px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .candidato-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .candidato-nombre { font-size: 18px; font-weight: 700; color: white; margin-bottom: 2px; }
        .candidato-meta { font-size: 13px; color: rgba(255,255,255,0.7); }

        /* PROMEDIOS */
        .promedios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .promedio-card {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 20px 24px;
        }

        .promedio-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--subtitulo);
            margin-bottom: 12px;
        }

        .promedio-valor { font-size: 36px; font-weight: 700; color: var(--azul); line-height: 1; margin-bottom: 10px; }

        .promedio-barra { height: 6px; background: var(--borde); border-radius: 3px; overflow: hidden; }
        .promedio-fill { height: 100%; background: var(--azul); border-radius: 3px; transition: width 0.6s ease; }

        /* EVALUACIONES */
        .evaluacion-card {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .evaluacion-card:last-child { margin-bottom: 0; }

        .evaluacion-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--borde);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .evaluacion-evaluador { font-size: 14px; font-weight: 700; color: var(--azul); }
        .evaluacion-empresa { font-size: 12px; color: var(--subtitulo); margin-top: 2px; }
        .evaluacion-fecha { font-size: 12px; color: var(--subtitulo); }
        .evaluacion-body { padding: 20px; }

        .eval-atributos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 0;
        }

        .eval-atributo-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--subtitulo);
            margin-bottom: 6px;
        }

        .eval-score { display: flex; align-items: center; gap: 8px; }
        .eval-score-num { font-size: 20px; font-weight: 700; color: var(--azul); min-width: 28px; }
        .eval-score-bar { flex: 1; height: 4px; background: var(--borde); border-radius: 2px; overflow: hidden; }
        .eval-score-fill { height: 100%; background: var(--azul); border-radius: 2px; }
        .eval-score-texto { font-size: 11px; color: var(--subtitulo); margin-top: 4px; }

        .eval-comentario {
            font-size: 13px;
            color: var(--subtitulo);
            background: var(--fondo-gris);
            border-left: 3px solid var(--borde);
            padding: 8px 12px;
            border-radius: 0 4px 4px 0;
            margin-top: 8px;
            line-height: 1.5;
        }

        .eval-otros {
            border-top: 1px solid var(--borde);
            padding-top: 16px;
            margin-top: 16px;
        }

        .eval-otros-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--subtitulo);
            margin-bottom: 6px;
        }

        .eval-otros-texto { font-size: 13px; color: var(--texto); line-height: 1.6; }

        .no-conoce-tag {
            background: rgba(239,68,68,0.08);
            border: 1px solid rgba(239,68,68,0.2);
            border-radius: 4px;
            padding: 10px 14px;
            font-size: 13px;
            color: #b91c1c;
        }

        /* BÚSQUEDA */
        .rut-search-card {
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 32px;
            max-width: 480px;
            margin-bottom: 28px;
        }

        .rut-search-title { font-size: 16px; font-weight: 700; color: var(--azul); margin-bottom: 6px; }
        .rut-search-desc { font-size: 14px; color: var(--subtitulo); margin-bottom: 20px; }
        .rut-search-form { display: flex; gap: 10px; }

        .rut-search-input {
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--texto);
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 10px 14px;
            flex: 1;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        .rut-search-input:focus { outline: none; border-color: var(--azul); box-shadow: 0 0 0 3px rgba(14,42,71,0.08); }

        /* EMPTY */
        .empty-state { text-align: center; padding: 48px 24px; }
        .empty-state-title { font-size: 15px; font-weight: 700; color: var(--azul); margin-bottom: 6px; }
        .empty-state-desc { font-size: 13px; color: var(--subtitulo); }

        /* MODALES */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--fondo);
            border-radius: 4px;
            width: 100%;
            max-width: 480px;
            overflow: hidden;
        }

        .modal-header {
            background: var(--azul);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-size: 16px; font-weight: 700; color: white; }

        .btn-close-modal {
            background: none;
            border: none;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
            transition: color 0.15s;
            display: flex;
        }

        .btn-close-modal:hover { color: white; }

        .modal-body { padding: 24px; }

        .modal-form-group { margin-bottom: 18px; }
        .modal-form-group:last-child { margin-bottom: 0; }
        .modal-label { font-size: 13px; font-weight: 500; color: var(--texto); margin-bottom: 6px; display: block; }
        .modal-label-opt { font-size: 11px; font-weight: 400; color: var(--subtitulo); }

        .modal-input {
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--texto);
            background: var(--fondo);
            border: 1px solid var(--borde);
            border-radius: 4px;
            padding: 10px 14px;
            width: 100%;
            transition: border-color 0.15s;
        }

        .modal-input:focus { outline: none; border-color: var(--azul); box-shadow: 0 0 0 3px rgba(14,42,71,0.08); }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--borde);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .promedios-grid { grid-template-columns: 1fr; }
            .eval-atributos { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <a href="index.html" class="sidebar-logo">
            <img src="Huella_Laboral.png" alt="Huella Laboral" style="height:36px; width:auto;">
        </a>

        <nav class="sidebar-nav">
            <div class="sidebar-section-label">Principal</div>
            <button class="sidebar-item active" id="nav-procesos" onclick="mostrarVista('procesos')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="7" width="20" height="14" rx="2"/>
                    <path d="M16 3H8L2 7h20z"/>
                </svg>
                <span class="sidebar-item-text">Procesos</span>
            </button>
            <button class="sidebar-item" id="nav-busqueda" onclick="mostrarVista('busqueda')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                <span class="sidebar-item-text">Buscar por RUT</span>
            </button>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-name" id="sidebarNombre">Reclutador</div>
                <div class="sidebar-user-email" id="sidebarEmail"></div>
            </div>
            <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

        <div class="topbar">
            <div class="topbar-title" id="topbarTitle">Procesos</div>
            <div class="topbar-actions" id="topbarActions">
                <button class="btn-primary" onclick="abrirModalProceso()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                    Nuevo proceso
                </button>
            </div>
        </div>

        <div class="content">

            <!-- VISTA PROCESOS -->
            <div class="vista active" id="vista-procesos">
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-label">Procesos activos</div><div class="stat-value" id="statProcesosActivos">—</div></div>
                    <div class="stat-card"><div class="stat-label">Procesos finalizados</div><div class="stat-value" id="statProcesosFinalizados">—</div></div>
                    <div class="stat-card"><div class="stat-label">Candidatos en evaluación</div><div class="stat-value" id="statCandidatosEvaluacion">—</div></div>
                    <div class="stat-card"><div class="stat-label">Candidatos validados</div><div class="stat-value" id="statCandidatosValidados">—</div></div>
                </div>
                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Proceso / Cargo</th>
                                <th>Candidatos</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tablaProcesos"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISTA CANDIDATOS -->
            <div class="vista" id="vista-candidatos">
                <button class="btn-back" onclick="mostrarVista('procesos')">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 4L6 8l4 4"/></svg>
                    Volver a procesos
                </button>
                <div class="proceso-header">
                    <div>
                        <div class="proceso-nombre" id="procesoNombre">—</div>
                        <div class="proceso-meta" id="procesoMeta">—</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div class="toggle-data">
                            <button id="toggleTotalProceso" class="active" onclick="cambiarVistaDataProceso('total')">Total</button>
                            <button id="toggleVerificadaProceso" onclick="cambiarVistaDataProceso('verificada')">Verificada</button>
                        </div>
                        <button class="btn-primary" onclick="abrirModalCandidato()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                            Agregar candidato
                        </button>
                    </div>
                </div>
                <div class="table-card">
                    <table>
                        <thead>
                            <tr>
                                <th style="cursor:pointer;" onclick="ordenarCandidatos('nombre')">Candidato <span id="sort-nombre"></span></th>
                                <th style="cursor:pointer;" onclick="ordenarCandidatos('promedio')">Promedio ↓ <span id="sort-promedio"></span></th>
                                <th>Puntualidad</th>
                                <th>Desempeño</th>
                                <th>Relaciones</th>
                                <th>Confiabilidad</th>
                                <th>Evaluaciones</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tablaCandidatos"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISTA RESULTADOS -->
            <div class="vista" id="vista-resultados">
                <button class="btn-back" onclick="mostrarVista('candidatos')">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 4L6 8l4 4"/></svg>
                    Volver a candidatos
                </button>
                <div class="candidato-header">
                    <div class="candidato-avatar">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="8" r="4"/>
                            <path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/>
                        </svg>
                    </div>
                    <div style="flex:1;">
                        <div class="candidato-nombre" id="resultadoNombre">—</div>
                        <div class="candidato-meta" id="resultadoMeta">—</div>
                    </div>
                    <div class="toggle-data">
                        <button id="toggleTotal" class="active" onclick="cambiarVistaData('total')">Total</button>
                        <button id="toggleVerificada" onclick="cambiarVistaData('verificada')">Verificada</button>
                    </div>
                </div>
                
                <!-- Datos de certificado y finiquito -->
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:24px;" id="datosValidados">
                    <div style="background:var(--fondo); border:1px solid var(--borde); border-radius:4px; padding:20px;">
                        <div style="font-size:12px; font-weight:500; color:var(--subtitulo); margin-bottom:8px;">Empleos en últimos 5 años</div>
                        <div style="font-size:24px; font-weight:700; color:var(--azul);" id="certEmpleos">—</div>
                    </div>
                    <div style="background:var(--fondo); border:1px solid var(--borde); border-radius:4px; padding:20px;">
                        <div style="font-size:12px; font-weight:500; color:var(--subtitulo); margin-bottom:8px;">Mayor permanencia en un empleo</div>
                        <div style="font-size:24px; font-weight:700; color:var(--azul);" id="certPermanencia">—</div>
                    </div>
                    <div style="background:var(--fondo); border:1px solid var(--borde); border-radius:4px; padding:20px;">
                        <div style="font-size:12px; font-weight:500; color:var(--subtitulo); margin-bottom:8px;">Causal de término</div>
                        <div style="font-size:16px; font-weight:500; color:var(--texto); margin-top:8px;" id="causalTexto">—</div>
                        <div style="margin-top:8px;" id="causalBadge"></div>
                    </div>
                </div>
                
                <!-- Promedio dinámico -->
                <div style="background:var(--fondo); border:1px solid var(--borde); border-radius:4px; padding:24px; text-align:center; margin-bottom:24px;">
                    <div style="font-size:13px; font-weight:500; color:var(--subtitulo); margin-bottom:8px;" id="promedioTitulo">Promedio General</div>
                    <div style="font-size:32px; font-weight:700; margin-bottom:4px;" id="promedioValor">—</div>
                    <div style="font-size:12px; color:var(--subtitulo);" id="promedioDesc">—</div>
                </div>
                
                <div class="promedios-grid">
                    <div class="promedio-card"><div class="promedio-label">Puntualidad</div><div class="promedio-valor" id="promPuntualidad">—</div><div class="promedio-barra"><div class="promedio-fill" id="barraPuntualidad" style="width:0%"></div></div></div>
                    <div class="promedio-card"><div class="promedio-label">Desempeño</div><div class="promedio-valor" id="promDesempeno">—</div><div class="promedio-barra"><div class="promedio-fill" id="barraDesempeno" style="width:0%"></div></div></div>
                    <div class="promedio-card"><div class="promedio-label">Relaciones Interpersonales</div><div class="promedio-valor" id="promRelaciones">—</div><div class="promedio-barra"><div class="promedio-fill" id="barraRelaciones" style="width:0%"></div></div></div>
                    <div class="promedio-card"><div class="promedio-label">Confiabilidad</div><div class="promedio-valor" id="promConfiabilidad">—</div><div class="promedio-barra"><div class="promedio-fill" id="barraConfiabilidad" style="width:0%"></div></div></div>
                </div>
                <div id="listaEvaluaciones"></div>
            </div>

            <!-- VISTA BÚSQUEDA -->
            <div class="vista" id="vista-busqueda">
                <div class="rut-search-card">
                    <div class="rut-search-title">Consulta por RUT</div>
                    <div class="rut-search-desc">Busca cualquier trabajador en el sistema para consultar sus evaluaciones.</div>
                    <div class="rut-search-form">
                        <input type="text" class="rut-search-input" id="rutBusqueda" placeholder="12.345.678-9" maxlength="12">
                        <button class="btn-primary" onclick="buscarPorRut()">Buscar</button>
                    </div>
                </div>
                <div id="resultadoBusqueda"></div>
            </div>

        </div>
    </main>
</div>

<!-- MODAL NUEVO PROCESO -->
<div class="modal-overlay" id="modalProceso">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Nuevo proceso</span>
            <button class="btn-close-modal" onclick="cerrarModalProceso()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label class="modal-label" for="nuevoProcesoCargo">Nombre del cargo o búsqueda</label>
                <input type="text" class="modal-input" id="nuevoProcesoCargo" placeholder="Analista Comercial — Febrero 2026">
            </div>
            <div class="modal-form-group">
                <label class="modal-label" for="nuevoProcesoDesc">Descripción <span class="modal-label-opt">(opcional)</span></label>
                <input type="text" class="modal-input" id="nuevoProcesoDesc" placeholder="Área, departamento u otros detalles">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="cerrarModalProceso()">Cancelar</button>
            <button class="btn-primary" onclick="crearProceso()">Crear proceso</button>
        </div>
    </div>
</div>

<!-- MODAL CONFIRMAR ELIMINAR PROCESO -->
<div class="modal-overlay" id="modalEliminarProceso">
    <div class="modal" style="max-width:440px;">
        <div class="modal-header">
            <span class="modal-title">Eliminar proceso</span>
            <button class="btn-close-modal" onclick="cerrarModalEliminar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="font-size:14px; color:var(--texto); line-height:1.6; margin-bottom:12px;">¿Estás seguro de que deseas eliminar el proceso <strong id="procesoEliminarNombre"></strong>?</p>
            <p style="font-size:13px; color:var(--subtitulo); line-height:1.6;">El proceso desaparecerá de tu vista pero los datos se mantendrán en el sistema.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="cerrarModalEliminar()">Cancelar</button>
            <button class="btn-primary" style="background:#dc2626; border-color:#dc2626;" onclick="eliminarProceso()">Eliminar proceso</button>
        </div>
    </div>
</div>

<!-- MODAL AGREGAR CANDIDATO -->
<div class="modal-overlay" id="modalCandidato">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Invitar candidato</span>
            <button class="btn-close-modal" onclick="cerrarModalCandidato()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label class="modal-label" for="candEmail">Email del candidato</label>
                <input type="email" class="modal-input" id="candEmail" placeholder="candidato@correo.cl">
            </div>
            <div class="modal-form-group">
                <label class="modal-label" for="candRut">RUT del candidato</label>
                <input type="text" class="modal-input" id="candRut" placeholder="12.345.678-9" maxlength="12">
            </div>
            <p style="font-size:13px; color:var(--subtitulo); margin-top:12px;">
                Si el candidato ya tiene evaluaciones en Huella Laboral, se agregará directamente. 
                Si no, le enviaremos una invitación para completar su perfil.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" onclick="cerrarModalCandidato()">Cancelar</button>
            <button class="btn-primary" onclick="agregarCandidato()">Invitar candidato</button>
        </div>
    </div>
</div>

<script>
    const escalaTextos = { 1: 'Muy mejorable', 2: 'Mejorable', 3: 'Suficiente', 4: 'Bueno', 5: 'Muy bueno' };

    // DATOS DEMO
    let procesos = [
        { id: 1, cargo: 'Analista Comercial', descripcion: 'Gerencia de ventas', estado: 'Activo', fecha: '2026-02-01', candidatos: 3 },
        { id: 2, cargo: 'Ingeniero de Proyectos', descripcion: 'Área de infraestructura', estado: 'Activo', fecha: '2026-01-15', candidatos: 2 },
    ];

    let candidatosPorProceso = {
        1: [
            { id: 1, nombre: 'María González', rut: '12.345.678-9', email: 'mgonzalez@mail.cl', empleadores: 3, evaluaciones: 3, estado: 'Completado', cert_empleos: 4, cert_permanencia: 3.5, causal_validada: true, causal_texto: 'Renuncia del trabajador' },
            { id: 2, nombre: 'Carlos Muñoz', rut: '15.432.100-K', email: 'cmunoz@mail.cl', empleadores: 2, evaluaciones: 1, estado: 'En proceso', cert_empleos: null, cert_permanencia: null, causal_validada: false, causal_texto: 'Mutuo acuerdo de las partes' },
            { id: 3, nombre: 'Andrea Soto', rut: '11.222.333-4', email: 'asoto@mail.cl', empleadores: 2, evaluaciones: 0, estado: 'Invitado', cert_empleos: null, cert_permanencia: null, causal_validada: null, causal_texto: null },
        ],
        2: [
            { id: 4, nombre: 'Roberto Lagos', rut: '9.876.543-2', email: 'rlagos@mail.cl', empleadores: 3, evaluaciones: 2, estado: 'En proceso', cert_empleos: 5, cert_permanencia: 2.0, causal_validada: true, causal_texto: 'Necesidades de la empresa' },
            { id: 5, nombre: 'Valentina Ríos', rut: '16.789.012-3', email: 'vrios@mail.cl', empleadores: 2, evaluaciones: 2, estado: 'Completado', cert_empleos: 3, cert_permanencia: 4.5, causal_validada: true, causal_texto: 'Renuncia del trabajador' },
        ]
    };

    let evaluacionesPorCandidato = {
        1: [
            { id: 1, evaluador: 'Jorge Herrera', empresa: 'Retail Norte S.A.', rut: '7.654.321-K', periodo: 'Mar 2021 — Dic 2023', verificada: true, no_conoce: false, puntualidad: { val: 5, comentario: 'Siempre puntual, sin ausencias injustificadas.' }, desempeno: { val: 4, comentario: 'Cumplió los objetivos del área con consistencia.' }, relaciones: { val: 4, comentario: '' }, confiabilidad: { val: 5, comentario: '' }, otros: 'Excelente actitud y disposición para el trabajo en equipo.' },
            { id: 2, evaluador: 'Claudia Vera', empresa: 'Distribuidora Central', rut: '13.456.789-0', periodo: 'Ene 2019 — Feb 2021', verificada: true, no_conoce: false, puntualidad: { val: 4, comentario: '' }, desempeno: { val: 4, comentario: 'Buen desempeño general.' }, relaciones: { val: 4, comentario: '' }, confiabilidad: { val: 4, comentario: '' }, otros: '' },
            { id: 3, evaluador: 'Marcelo Pizarro', empresa: 'Pyme Tech Ltda.', rut: '10.111.222-3', periodo: 'Jun 2017 — Dic 2018', verificada: false, no_conoce: false, puntualidad: { val: 3, comentario: 'Algunos retrasos menores durante los primeros meses.' }, desempeno: { val: 3, comentario: '' }, relaciones: { val: 4, comentario: '' }, confiabilidad: { val: 4, comentario: '' }, otros: '' },
        ],
        2: [
            { id: 1, evaluador: 'Sergio Henríquez', empresa: 'Tech Retail', rut: '8.555.666-7', periodo: 'May 2022 — Dic 2024', verificada: false, no_conoce: false, puntualidad: { val: 3, comentario: '' }, desempeno: { val: 3, comentario: '' }, relaciones: { val: 4, comentario: '' }, confiabilidad: { val: 3, comentario: '' }, otros: '' },
        ],
        4: [
            { id: 1, evaluador: 'Patricia Morales', empresa: 'Constructora del Sur', rut: '9.876.543-2', periodo: 'Abr 2020 — Nov 2024', verificada: true, no_conoce: false, puntualidad: { val: 4, comentario: '' }, desempeno: { val: 4, comentario: '' }, relaciones: { val: 5, comentario: '' }, confiabilidad: { val: 4, comentario: '' }, otros: 'Muy buen manejo de equipos multidisciplinarios.' },
            { id: 2, evaluador: 'Roberto Silva', empresa: 'Ingeniería Integral', rut: '15.222.333-4', periodo: 'Ene 2018 — Mar 2020', verificada: true, no_conoce: false, puntualidad: { val: 3, comentario: '' }, desempeno: { val: 3, comentario: '' }, relaciones: { val: 3, comentario: '' }, confiabilidad: { val: 4, comentario: '' }, otros: '' },
        ],
        5: [
            { id: 1, evaluador: 'Luis Ramírez', empresa: 'Tech Solutions SpA', rut: '11.444.555-6', periodo: 'Jul 2022 — Dic 2024', verificada: true, no_conoce: false, puntualidad: { val: 5, comentario: '' }, desempeno: { val: 5, comentario: 'Excelente capacidad técnica y liderazgo.' }, relaciones: { val: 5, comentario: '' }, confiabilidad: { val: 5, comentario: '' }, otros: 'Destacada en gestión de proyectos complejos.' },
            { id: 2, evaluador: 'Ana Torres', empresa: 'Consultora Prime', rut: '8.777.888-9', periodo: 'Mar 2020 — Jun 2022', verificada: true, no_conoce: false, puntualidad: { val: 4, comentario: '' }, desempeno: { val: 4, comentario: '' }, relaciones: { val: 4, comentario: '' }, confiabilidad: { val: 5, comentario: '' }, otros: '' },
        ]
    };

    let procesoActual = null;
    let vistaDataActual = 'total'; // 'total' o 'verificada' (para vista de resultados)
    let vistaDataProceso = 'total'; // 'total' o 'verificada' (para tabla comparativa)
    let candidatoActualData = {}; // guarda ambos promedios

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        // Verificar autenticación
        const token = localStorage.getItem('hl_token');
        const usuario = JSON.parse(localStorage.getItem('hl_usuario') || 'null');
        
        if (!token || !usuario) {
            window.location.href = 'login.html';
            return;
        }
        
        // Cargar datos del usuario
        document.getElementById('sidebarNombre').textContent = usuario.nombre || 'Reclutador';
        document.getElementById('sidebarEmail').textContent = usuario.email || '';
        
        cargarProcesos();
        actualizarStats();
    });

    // NAVEGACIÓN
    function mostrarVista(vista) {
        document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
        document.getElementById(`vista-${vista}`).classList.add('active');
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        if (vista === 'procesos' || vista === 'candidatos' || vista === 'resultados') document.getElementById('nav-procesos').classList.add('active');
        if (vista === 'busqueda') document.getElementById('nav-busqueda').classList.add('active');

        const titulos = { procesos: 'Procesos', candidatos: 'Candidatos', resultados: 'Resultados del candidato', busqueda: 'Buscar por RUT' };
        document.getElementById('topbarTitle').textContent = titulos[vista];

        const acciones = document.getElementById('topbarActions');
        acciones.innerHTML = vista === 'procesos'
            ? `<button class="btn-primary" onclick="abrirModalProceso()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>Nuevo proceso</button>`
            : '';
    }

    // PROCESOS
    async function cargarProcesos() {
        const tbody = document.getElementById('tablaProcesos');
        
        try {
            const usuario = JSON.parse(localStorage.getItem('hl_usuario'));
            const response = await fetch(`https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/listar-procesos?user_id=${usuario.id}`, {
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                }
            });

            if (!response.ok) throw new Error('Error cargando procesos');

            const data = await response.json();
            procesos = data.procesos || [];

            tbody.innerHTML = procesos.length
                ? procesos.map(p => {
                let estadoProceso = p.estado || 'Activo';
                let badgeClass = estadoProceso === 'Finalizado' ? 'badge-completo' : 
                                  estadoProceso === 'Activo' ? 'badge-en-progreso' : 'badge-pendiente';
                
                return `
                <tr>
                    <td><div class="td-name">${p.cargo}</div><div class="td-sub">${p.descripcion || ''}</div></td>
                    <td>${p.candidatos}</td>
                    <td><span class="badge ${badgeClass}">${estadoProceso}</span></td>
                    <td>${formatFecha(p.fecha)}</td>
                    <td><button class="btn-accion" onclick="verCandidatos('${p.id}')">Ver candidatos</button></td>
                    <td style="white-space:nowrap;">
                        <button class="btn-finalizar" onclick="finalizarProceso('${p.id}')" style="margin-right:6px;" title="Finalizar proceso">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <path d="M22 4L12 14.01l-3-3"/>
                            </svg>
                        </button>
                        <button class="btn-eliminar" onclick="confirmarEliminarProceso('${p.id}')" title="Eliminar proceso">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/>
                            </svg>
                        </button>
                    </td>
                </tr>`;
            }).join('')
            : `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-title">Sin procesos</div><div class="empty-state-desc">Crea tu primer proceso para comenzar.</div></div></td></tr>`;
        
        } catch (error) {
            console.error('Error cargando procesos:', error);
            tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-state-title">Error</div><div class="empty-state-desc">No se pudieron cargar los procesos.</div></div></td></tr>`;
        }
    }

    function actualizarStats() {
        document.getElementById('statProcesosActivos').textContent = procesos.filter(p => p.estado === 'Activo').length;
        document.getElementById('statProcesosFinalizados').textContent = procesos.filter(p => p.estado === 'Finalizado').length;
        const todos = Object.values(candidatosPorProceso).flat();
        document.getElementById('statCandidatosEvaluacion').textContent = todos.filter(c => c.estado === 'En proceso' || c.estado === 'Invitado').length;
        document.getElementById('statCandidatosValidados').textContent = todos.filter(c => c.estado === 'Completado').length;
    }

    // CANDIDATOS - Vista comparativa
    async function verCandidatos(procesoId) {
        vistaDataProceso = 'total';
        document.getElementById('toggleTotalProceso').classList.add('active');
        document.getElementById('toggleVerificadaProceso').classList.remove('active');
        
        procesoActual = procesos.find(p => p.id === procesoId);
        document.getElementById('procesoNombre').textContent = procesoActual.cargo;
        document.getElementById('procesoMeta').textContent = `${procesoActual.descripcion || ''} — Creado el ${formatFecha(procesoActual.fecha)}`;

        // Cargar candidatos del proceso desde la BD
        try {
            const response = await fetch(`https://dxblzmxcmaerycvdgfpy.supabase.co/rest/v1/candidatos_proceso?proceso_id=eq.${procesoId}&select=*,trabajadores(*)`, {
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                }
            });

            const candidatosRaw = await response.json();
            
            // Transformar a formato esperado
            const candidatos = candidatosRaw.map(c => {
                if (c.trabajador_id && c.trabajadores) {
                    // Candidato con datos completos
                    return {
                        id: c.trabajadores.id,
                        nombre: c.trabajadores.nombre,
                        rut: c.trabajadores.rut,
                        email: c.trabajadores.email,
                        empleadores: 0, // Se calculará después
                        evaluaciones: 0,
                        estado: 'En proceso',
                        pendiente: false
                    };
                } else {
                    // Invitación pendiente
                    return {
                        id: c.id,
                        nombre: '(Invitación pendiente)',
                        rut: c.rut_invitado,
                        email: c.email_invitado,
                        empleadores: 0,
                        evaluaciones: 0,
                        estado: 'Invitado',
                        pendiente: true
                    };
                }
            });
            
            // Calcular promedios (solo para candidatos con datos)
            procesoActual.candidatosData = candidatos.map(c => ({
                ...c,
                total: { count: 0, promedio: null },
                verificada: { count: 0, promedio: null }
            }));

            renderizarTablaCandidatos();
            mostrarVista('candidatos');
            
        } catch (error) {
            console.error('Error cargando candidatos:', error);
            procesoActual.candidatosData = [];
            renderizarTablaCandidatos();
            mostrarVista('candidatos');
        }
    }

    function renderizarTablaCandidatos() {
        const candidatosData = procesoActual.candidatosData || [];
        const vista = vistaDataProceso;
        
        // Ordenar: invitados al final, luego por promedio
        const candidatosOrdenados = [...candidatosData].sort((a, b) => {
            if (a.pendiente && !b.pendiente) return 1;
            if (!a.pendiente && b.pendiente) return -1;
            return (b[vista].promedio || 0) - (a[vista].promedio || 0);
        });

        const tbody = document.getElementById('tablaCandidatos');
        tbody.innerHTML = candidatosData.length
            ? candidatosOrdenados.map(c => {
                if (c.pendiente) {
                    // Invitación pendiente
                    return `
                    <tr style="opacity:0.6;">
                        <td><div class="td-name">${c.email}</div><div class="td-sub">${c.rut}</div></td>
                        <td colspan="6" style="text-align:center;"><span style="font-size:12px; color:var(--subtitulo); background:var(--fondo-gris); padding:4px 12px; border-radius:12px;">⏳ Invitación pendiente</span></td>
                        <td><span style="font-size:12px;color:var(--subtitulo);">Esperando respuesta</span></td>
                    </tr>`;
                } else {
                    // Candidato con datos
                    const d = c[vista];
                    return `
                    <tr>
                        <td><div class="td-name">${c.nombre}</div><div class="td-sub">${c.rut}</div></td>
                        <td><strong style="font-size:18px;color:var(--azul);">${d.promedio ? d.promedio.toFixed(1) : '—'}</strong></td>
                        <td>${d.puntualidad || '—'}</td>
                        <td>${d.desempeno || '—'}</td>
                        <td>${d.relaciones || '—'}</td>
                        <td>${d.confiabilidad || '—'}</td>
                        <td>${d.count} / ${c.empleadores}</td>
                        <td>${c.evaluaciones > 0
                            ? `<button class="btn-accion" onclick="verResultados('${c.id}')">Ver detalle</button>`
                            : `<span style="font-size:12px;color:var(--subtitulo);">Sin evaluaciones</span>`}
                        </td>
                    </tr>`;
                }
            }).join('')
            : `<tr><td colspan="8"><div class="empty-state"><div class="empty-state-title">Sin candidatos</div><div class="empty-state-desc">Agrega candidatos a este proceso.</div></div></td></tr>`;
    }

    function cambiarVistaDataProceso(vista) {
        vistaDataProceso = vista;
        const btnTotal = document.getElementById('toggleTotalProceso');
        const btnVerificada = document.getElementById('toggleVerificadaProceso');
        
        btnTotal.classList.toggle('active', vista === 'total');
        btnVerificada.classList.toggle('active', vista === 'verificada');
        
        if (vista === 'verificada') {
            btnVerificada.classList.add('verificada');
        } else {
            btnVerificada.classList.remove('verificada');
        }
        
        renderizarTablaCandidatos();
    }

    // Función de ordenamiento (placeholder - se puede mejorar después)
    function ordenarCandidatos(criterio) {
        // Por ahora no hace nada, se puede implementar después si se requiere
    }

    // RESULTADOS
    function verResultados(candidatoId) {
        vistaDataActual = 'total'; // Reset a total al abrir
        document.getElementById('toggleTotal').classList.add('active');
        document.getElementById('toggleVerificada').classList.remove('active');
        
        const candidato = Object.values(candidatosPorProceso).flat().find(c => c.id === candidatoId);
        document.getElementById('resultadoNombre').textContent = candidato.nombre;
        
        // Poblar datos de certificado y finiquito validados
        document.getElementById('certEmpleos').textContent = candidato.cert_empleos !== null ? candidato.cert_empleos : '—';
        document.getElementById('certPermanencia').textContent = candidato.cert_permanencia !== null ? candidato.cert_permanencia + ' años' : '—';
        document.getElementById('causalTexto').textContent = candidato.causal_texto || '—';
        
        const badgeHtml = candidato.causal_validada === true 
            ? '<span style="font-size:10px; font-weight:700; color:#166534; background:rgba(47,191,113,0.12); padding:3px 8px; border-radius:2px;">✓ VALIDADA</span>'
            : candidato.causal_validada === false
            ? '<span style="font-size:10px; font-weight:700; color:#dc2626; background:rgba(220,38,38,0.12); padding:3px 8px; border-radius:2px;">✗ NO VALIDADA</span>'
            : '';
        document.getElementById('causalBadge').innerHTML = badgeHtml;

        const evaluaciones = evaluacionesPorCandidato[candidatoId] || [];
        const validas = evaluaciones.filter(e => !e.no_conoce);
        const verificadas = validas.filter(e => e.verificada);
        const atributos = ['puntualidad', 'desempeno', 'relaciones', 'confiabilidad'];

        // Calcular y guardar ambos promedios
        candidatoActualData = {
            candidato: candidato,
            total: { evaluaciones: validas, count: validas.length, promedios: {} },
            verificada: { evaluaciones: verificadas, count: verificadas.length, promedios: {} }
        };

        // Calcular promedios totales
        if (validas.length) {
            const promedioGral = atributos.reduce((sum, attr) => {
                const prom = validas.reduce((s, e) => s + e[attr].val, 0) / validas.length;
                candidatoActualData.total.promedios[attr] = prom;
                return sum + prom;
            }, 0) / atributos.length;
            candidatoActualData.total.promedioGeneral = promedioGral;
        }

        // Calcular promedios verificados
        if (verificadas.length) {
            const promedioVerif = atributos.reduce((sum, attr) => {
                const prom = verificadas.reduce((s, e) => s + e[attr].val, 0) / verificadas.length;
                candidatoActualData.verificada.promedios[attr] = prom;
                return sum + prom;
            }, 0) / atributos.length;
            candidatoActualData.verificada.promedioGeneral = promedioVerif;
        }

        // Renderizar vista inicial (total)
        renderizarVista();

        document.getElementById('listaEvaluaciones').innerHTML = evaluaciones.map(e => `
            <div class="evaluacion-card">
                <div class="evaluacion-header">
                    <div>
                        <div class="evaluacion-evaluador">
                            ${e.evaluador}
                            ${e.verificada ? '<span style="display:inline-block; margin-left:6px; font-size:10px; font-weight:700; color:#166534; background:rgba(47,191,113,0.12); padding:2px 6px; border-radius:2px;">✓ VERIFICADA</span>' : ''}
                        </div>
                        <div class="evaluacion-empresa">${e.empresa} — RUT ${e.rut}</div>
                    </div>
                    <div class="evaluacion-fecha">${e.periodo}</div>
                </div>
                <div class="evaluacion-body">
                    ${e.no_conoce
                        ? '<div class="no-conoce-tag">El evaluador indicó no conocer o no haber trabajado con este candidato.</div>'
                        : `<div class="eval-atributos">
                            ${['puntualidad', 'desempeno', 'relaciones', 'confiabilidad'].map(attr => `
                                <div>
                                    <div class="eval-atributo-label">${
                                        attr === 'desempeno' ? 'Desempeño' : 
                                        attr === 'relaciones' ? 'Relaciones Interpersonales' :
                                        attr.charAt(0).toUpperCase() + attr.slice(1)
                                    }</div>
                                    <div class="eval-score">
                                        <span class="eval-score-num">${e[attr].val}</span>
                                        <div class="eval-score-bar"><div class="eval-score-fill" style="width:${e[attr].val / 5 * 100}%"></div></div>
                                    </div>
                                    <div class="eval-score-texto">${escalaTextos[e[attr].val]}</div>
                                </div>`).join('')}
                           </div>
                           ${e.otros ? `<div class="eval-otros"><div class="eval-otros-label">Comentarios adicionales</div><div class="eval-otros-texto">${e.otros}</div></div>` : ''}`
                    }
                </div>
            </div>`).join('');

        mostrarVista('resultados');
    }

    function renderizarVista() {
        const data = candidatoActualData[vistaDataActual];
        const candidato = candidatoActualData.candidato;
        const atributos = ['puntualidad', 'desempeno', 'relaciones', 'confiabilidad'];
        
        // Actualizar meta con cantidad de evaluaciones según vista
        const tipoEval = vistaDataActual === 'total' ? '' : ' verificada' + (data.count > 1 ? 's' : '');
        document.getElementById('resultadoMeta').textContent = `${candidato.rut} — ${data.count} evaluación${data.count > 1 ? 'es' : ''}${tipoEval} recibida${data.count > 1 ? 's' : ''}`;
        
        // Actualizar card de promedio
        if (data.count > 0 && data.promedioGeneral) {
            const color = vistaDataActual === 'total' ? 'var(--azul)' : 'var(--verde)';
            const titulo = vistaDataActual === 'total' ? 'Promedio General' : 'Promedio Verificado ✓';
            const sufijo = vistaDataActual === 'verificada' ? ' verificada' + (data.count > 1 ? 's' : '') : '';
            
            document.getElementById('promedioTitulo').textContent = titulo;
            document.getElementById('promedioValor').textContent = data.promedioGeneral.toFixed(1);
            document.getElementById('promedioValor').style.color = color;
            document.getElementById('promedioDesc').textContent = `Basado en ${data.count} evaluación${data.count > 1 ? 'es' : ''}${sufijo}`;
            
            // Actualizar promedios individuales
            atributos.forEach(attr => {
                const prom = data.promedios[attr].toFixed(1);
                const attrCapitalized = attr === 'desempeno' ? 'Desempeno' : attr.charAt(0).toUpperCase() + attr.slice(1);
                document.getElementById(`prom${attrCapitalized}`).textContent = prom;
                document.getElementById(`barra${attrCapitalized}`).style.width = (prom / 5 * 100) + '%';
            });
        } else {
            document.getElementById('promedioTitulo').textContent = 'Promedio Verificado ✓';
            document.getElementById('promedioValor').textContent = '—';
            document.getElementById('promedioValor').style.color = 'var(--subtitulo)';
            document.getElementById('promedioDesc').textContent = 'Sin evaluaciones verificadas';
            
            // Limpiar promedios individuales
            atributos.forEach(attr => {
                const attrCapitalized = attr === 'desempeno' ? 'Desempeno' : attr.charAt(0).toUpperCase() + attr.slice(1);
                document.getElementById(`prom${attrCapitalized}`).textContent = '—';
                document.getElementById(`barra${attrCapitalized}`).style.width = '0%';
            });
        }
    }

    function cambiarVistaData(vista) {
        vistaDataActual = vista;
        const btnTotal = document.getElementById('toggleTotal');
        const btnVerificada = document.getElementById('toggleVerificada');
        
        btnTotal.classList.toggle('active', vista === 'total');
        btnVerificada.classList.toggle('active', vista === 'verificada');
        
        if (vista === 'verificada') {
            btnVerificada.classList.add('verificada');
        } else {
            btnVerificada.classList.remove('verificada');
        }
        
        renderizarVista();
    }

    // BÚSQUEDA RUT
    document.getElementById('rutBusqueda').addEventListener('input', function (e) {
        let v = e.target.value.replace(/[^0-9kK]/g, '');
        if (v.length > 1) { e.target.value = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + v.slice(-1).toUpperCase(); }
        else e.target.value = v;
    });
    
    // Formatear RUT en modal de candidato
    document.getElementById('candRut').addEventListener('input', function (e) {
        let v = e.target.value.replace(/[^0-9kK]/g, '');
        if (v.length > 1) { e.target.value = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + v.slice(-1).toUpperCase(); }
        else e.target.value = v;
    });

    // Validación de RUT chileno
    function validarRutChileno(rut) {
        // Limpiar formato
        rut = rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
        
        if (rut.length < 2) return false;
        
        // Separar número y dígito verificador
        const numero = rut.slice(0, -1);
        const dvIngresado = rut.slice(-1);
        
        // Validar que el número sea válido
        if (!/^\d+$/.test(numero)) return false;
        
        // Calcular dígito verificador esperado
        let suma = 0;
        let multiplicador = 2;
        
        for (let i = numero.length - 1; i >= 0; i--) {
            suma += parseInt(numero[i]) * multiplicador;
            multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }
        
        const resto = suma % 11;
        const dvEsperado = resto === 0 ? '0' : resto === 1 ? 'K' : String(11 - resto);
        
        return dvIngresado === dvEsperado;
    }

    async function buscarPorRut() {
        const rut = document.getElementById('rutBusqueda').value.trim();
        const contenedor = document.getElementById('resultadoBusqueda');
        const btn = event.target;
        
        if (!rut) {
            contenedor.innerHTML = '<div style="padding:32px; text-align:center; color:var(--subtitulo);">Ingresa un RUT para buscar</div>';
            return;
        }
        
        // Validar formato RUT
        if (!/^\d{1,2}\.\d{3}\.\d{3}-[\dkK]$/.test(rut)) {
            contenedor.innerHTML = '<div class="table-card" style="padding:32px; text-align:center;"><div class="empty-state-title">Formato inválido</div><div class="empty-state-desc" style="margin-top:6px;">Ingresa un RUT con formato XX.XXX.XXX-X</div></div>';
            return;
        }
        
        // Validar dígito verificador
        if (!validarRutChileno(rut)) {
            contenedor.innerHTML = '<div class="table-card" style="padding:32px; text-align:center;"><div class="empty-state-title">RUT inválido</div><div class="empty-state-desc" style="margin-top:6px;">El dígito verificador no es correcto</div></div>';
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Buscando...';
        contenedor.innerHTML = '<div style="padding:32px; text-align:center; color:var(--subtitulo);">Buscando...</div>';

        try {
            const token = localStorage.getItem('hl_token');
            const response = await fetch(`https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/obtener-candidato?rut=${encodeURIComponent(rut)}`, {
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    contenedor.innerHTML = `<div class="table-card" style="padding:32px; text-align:center;"><div class="empty-state-title">Sin resultados</div><div class="empty-state-desc" style="margin-top:6px;">No se encontró ningún trabajador con el RUT <strong>${rut}</strong>.</div></div>`;
                } else {
                    throw new Error('Error al buscar');
                }
                btn.disabled = false;
                btn.textContent = 'Buscar';
                return;
            }

            const data = await response.json();
            
            // Mostrar vista completa de resultados usando los datos de la API
            mostrarResultadosBusqueda(data);
            
            btn.disabled = false;
            btn.textContent = 'Buscar';

        } catch (error) {
            console.error('Error:', error);
            contenedor.innerHTML = `<div class="table-card" style="padding:32px; text-align:center;"><div class="empty-state-title">Error</div><div class="empty-state-desc" style="margin-top:6px;">Ocurrió un error al buscar. Intenta nuevamente.</div></div>`;
            btn.disabled = false;
            btn.textContent = 'Buscar';
        }
    }

    function mostrarResultadosBusqueda(data) {
        // Guardar datos del candidato para la vista
        const trabajador = data.trabajador;
        const evaluaciones = data.evaluaciones.lista || [];
        const promedios = data.promedios;
        const documentos = data.documentos;
        
        // Poblar vista de resultados
        vistaDataActual = 'total';
        document.getElementById('toggleTotal').classList.add('active');
        document.getElementById('toggleVerificada').classList.remove('active');
        
        document.getElementById('resultadoNombre').textContent = trabajador.nombre;
        
        // Datos de documentos validados
        document.getElementById('certEmpleos').textContent = documentos.cert_empleos !== null ? documentos.cert_empleos : '—';
        document.getElementById('certPermanencia').textContent = documentos.cert_permanencia !== null ? documentos.cert_permanencia + ' años' : '—';
        document.getElementById('causalTexto').textContent = documentos.causal_validada || '—';
        
        const badgeHtml = documentos.causal_validada
            ? '<span style="font-size:10px; font-weight:700; color:#166534; background:rgba(47,191,113,0.12); padding:3px 8px; border-radius:2px;">✓ VALIDADA</span>'
            : '';
        document.getElementById('causalBadge').innerHTML = badgeHtml;

        const validas = evaluaciones.filter(e => !e.rechazo);
        const verificadas = validas.filter(e => e.verificada);

        // Guardar datos para toggle
        candidatoActualData = {
            candidato: { nombre: trabajador.nombre, rut: trabajador.rut },
            total: { 
                evaluaciones: validas, 
                count: validas.length, 
                promedios: promedios.total || {},
                promedioGeneral: promedios.total?.promedio || 0
            },
            verificada: { 
                evaluaciones: verificadas, 
                count: verificadas.length, 
                promedios: promedios.verificado || {},
                promedioGeneral: promedios.verificado?.promedio || 0
            }
        };

        // Renderizar vista
        renderizarVista();

        // Renderizar lista de evaluaciones
        document.getElementById('listaEvaluaciones').innerHTML = evaluaciones.map(e => `
            <div class="evaluacion-card">
                <div class="evaluacion-header">
                    <div>
                        <div class="evaluacion-evaluador">
                            ${e.nombre_evaluador}
                            ${e.verificada ? '<span style="display:inline-block; margin-left:6px; font-size:10px; font-weight:700; color:#166534; background:rgba(47,191,113,0.12); padding:2px 6px; border-radius:2px;">✓ VERIFICADA</span>' : ''}
                        </div>
                        <div class="evaluacion-empresa">${e.empresa_evaluador || '—'} — RUT ${e.rut_evaluador || '—'}</div>
                    </div>
                    <div class="evaluacion-fecha">${e.cargo || '—'} (${e.tiempo_trabajo || '—'})</div>
                </div>
                <div class="evaluacion-body">
                    ${e.rechazo
                        ? '<div class="no-conoce-tag">El evaluador indicó no conocer o no desear evaluar a este candidato.</div>'
                        : `<div class="eval-atributos">
                            ${['puntualidad', 'desempeno', 'relaciones', 'confiabilidad'].map(attr => `
                                <div>
                                    <div class="eval-atributo-label">${
                                        attr === 'desempeno' ? 'Desempeño' : 
                                        attr === 'relaciones' ? 'Relaciones Interpersonales' :
                                        attr.charAt(0).toUpperCase() + attr.slice(1)
                                    }</div>
                                    <div class="eval-score">
                                        <span class="eval-score-num">${e[attr]}</span>
                                        <div class="eval-score-bar"><div class="eval-score-fill" style="width:${e[attr] / 5 * 100}%"></div></div>
                                    </div>
                                    <div class="eval-score-texto">${escalaTextos[e[attr]]}</div>
                                </div>`).join('')}
                           </div>
                           ${e.comentarios ? `<div class="eval-otros"><div class="eval-otros-label">Comentarios adicionales</div><div class="eval-otros-texto">${e.comentarios}</div></div>` : ''}`
                    }
                </div>
            </div>`).join('');

        // Cambiar a vista de resultados
        mostrarVista('resultados');
    }

    function mostrarDetalleCandidato(data) {
        // Por ahora solo mostramos los datos en consola
        // Más adelante implementaremos la vista de detalle completa
        console.log('Datos del candidato:', data);
        alert(`Candidato: ${data.trabajador.nombre}
Evaluaciones: ${data.evaluaciones.total}
Promedio: ${data.promedios.total?.promedio?.toFixed(1) || '—'}

(Próximamente: vista de detalle completa)`);
    }

    // MODALES
    function abrirModalProceso() { document.getElementById('modalProceso').classList.add('visible'); }
    function cerrarModalProceso() { document.getElementById('modalProceso').classList.remove('visible'); }
    
    let procesoAEliminar = null;

    function confirmarEliminarProceso(procesoId) {
        procesoAEliminar = procesos.find(p => p.id === procesoId);
        document.getElementById('procesoEliminarNombre').textContent = procesoAEliminar.cargo;
        document.getElementById('modalEliminarProceso').classList.add('visible');
    }

    function cerrarModalEliminar() {
        document.getElementById('modalEliminarProceso').classList.remove('visible');
        procesoAEliminar = null;
    }

    function eliminarProceso() {
        if (!procesoAEliminar) return;
        
        // Soft delete: marcar como eliminado (en producción se enviaría al webhook)
        // Por ahora solo lo quitamos del array para el demo
        procesos = procesos.filter(p => p.id !== procesoAEliminar.id);
        
        cerrarModalEliminar();
        cargarProcesos();
        actualizarStats();
        
        // En producción:
        // fetch('WEBHOOK_ELIMINAR_PROCESO', { 
        //   method: 'POST', 
        //   body: JSON.stringify({ proceso_id: procesoAEliminar.id, eliminado: true })
        // });
    }

    function finalizarProceso(procesoId) {
        const proceso = procesos.find(p => p.id === procesoId);
        if (!proceso) return;
        
        // Marcar proceso como finalizado
        proceso.estado = 'Finalizado';
        
        cargarProcesos();
        actualizarStats();
        
        // En producción:
        // fetch('WEBHOOK_FINALIZAR_PROCESO', { 
        //   method: 'POST', 
        //   body: JSON.stringify({ proceso_id: procesoId, estado: 'Finalizado' })
        // });
    }
    
    function abrirModalCandidato() { document.getElementById('modalCandidato').classList.add('visible'); }
    function cerrarModalCandidato() { document.getElementById('modalCandidato').classList.remove('visible'); }

    async function crearProceso() {
        const cargo = document.getElementById('nuevoProcesoCargo').value.trim();
        const descripcion = document.getElementById('nuevoProcesoDesc').value.trim();
        
        if (!cargo) return;

        try {
            const usuario = JSON.parse(localStorage.getItem('hl_usuario'));
            const response = await fetch('https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/crear-proceso', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                },
                body: JSON.stringify({ 
                    user_id: usuario.id,
                    cargo, 
                    descripcion 
                })
            });

            const result = await response.json();

            if (!response.ok || result.error) {
                alert('Error al crear proceso: ' + (result.error || 'Error desconocido'));
                return;
            }

            cargarProcesos();
            actualizarStats();
            cerrarModalProceso();
            document.getElementById('nuevoProcesoCargo').value = '';
            document.getElementById('nuevoProcesoDesc').value = '';

        } catch (error) {
            console.error('Error:', error);
            alert('Error al crear proceso');
        }
    }

    async function agregarCandidato() {
        const email = document.getElementById('candEmail').value.trim();
        const rut = document.getElementById('candRut').value.trim();
        
        if (!email || !rut) {
            alert('Ingresa email y RUT del candidato');
            return;
        }
        
        // Validar formato RUT
        if (!/^\d{1,2}\.\d{3}\.\d{3}-[\dkK]$/.test(rut)) {
            alert('Formato de RUT inválido. Usa el formato XX.XXX.XXX-X');
            return;
        }
        
        // Validar dígito verificador
        if (!validarRutChileno(rut)) {
            alert('RUT inválido: el dígito verificador no es correcto');
            return;
        }
        
        if (!procesoActual) {
            alert('No hay proceso seleccionado');
            return;
        }

        try {
            const usuario = JSON.parse(localStorage.getItem('hl_usuario'));
            const response = await fetch('https://dxblzmxcmaerycvdgfpy.supabase.co/functions/v1/agregar-candidato', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c',
                    'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Ymx6bXhjbWFlcnljdmRnZnB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTgxNDUsImV4cCI6MjA4NzQzNDE0NX0.NCwvIYGT3hinm0EW3e8EkdSYZgHiCTNkuvDohR0SP0c'
                },
                body: JSON.stringify({ 
                    proceso_id: procesoActual.id,
                    email: email,
                    rut: rut,
                    reclutador_nombre: usuario.nombre || usuario.email
                })
            });

            const result = await response.json();

            if (!response.ok || result.error) {
                alert(result.error || 'Error al agregar candidato');
                return;
            }

            // Mostrar mensaje según el tipo
            if (result.tipo === 'existente') {
                alert('✓ ' + result.mensaje);
            } else {
                alert('✓ ' + result.mensaje);
            }

            // Recargar candidatos del proceso
            verCandidatos(procesoActual.id);
            cerrarModalCandidato();
            document.getElementById('candEmail').value = '';
            document.getElementById('candRut').value = '';

        } catch (error) {
            console.error('Error:', error);
            alert('Error al agregar candidato');
        }
    }

    function formatFecha(f) {
        return new Date(f).toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function cerrarSesion() {
        localStorage.removeItem('hl_token');
        localStorage.removeItem('hl_user');
        window.location.href = 'login.html';
    }
</script>

</body>
</html>
